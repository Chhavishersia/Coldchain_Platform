<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ColdChainX – CCaaP Prototype</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 (prod) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Framer Motion (UMD) -->
    <script src="https://unpkg.com/framer-motion@11.0.0/dist/framer-motion.umd.js"></script>
    <!-- Babel (to transpile TSX in-browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      html, body, #root { height: 100%; }
      body { background: #fafafa; }
      .util-bar { height: 10px; border-radius: 9999px; overflow: hidden; background:#eee; }
      .util-fill { height: 100%; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
      const { useMemo, useState } = React;
      const { createRoot } = ReactDOM;
      const fmGlobal = (window).framerMotion || (window)["framer-motion"] || {};
      const { motion } = fmGlobal;

      const roles = ["FPO", "Distributor", "Retailer"] as const;
      type Role = typeof roles[number];
      type Lot = { id: string; crop: string; variety: string; weight: number; score: number; days: number };
      type RouteName =
        | "home" | "fpo.pre-cool" | "fpo.find-reefer"
        | "dist.nudge" | "dist.reroute" | "dist.dispute" | "dist.build"
        | "retailer.cart" | "retailer.qc" | "retailer.fast";
      type Route = { name: RouteName; params?: Record<string, any> };

      const seedLots: Lot[] = [
        { id: "LOT-NSK-001", crop: "Grapes", variety: "Thompson", weight: 800, score: 92, days: 9 },
        { id: "LOT-NSK-002", crop: "Tomato", variety: "Arka", weight: 1200, score: 81, days: 4 },
        { id: "LOT-NSK-003", crop: "Pomegranate", variety: "Bhagwa", weight: 600, score: 87, days: 6 },
      ];

      const nextLotId = (countSoFar: number, prefix = "LOT-NSK-") => {
        const n = countSoFar + 1;
        const padded = String(n).padStart(3, "0");
        return `${prefix}${padded}`;
      };

      function Header({ role, setRole, navigate }: { role: Role; setRole: (r: Role) => void; navigate: (r: Route) => void }) {
        return (
          <div className="flex items-center justify-between py-4">
            <div className="text-2xl font-bold">ColdChainX</div>
            <div className="flex items-center gap-3">
              {roles.map((r) => (
                <button key={r} onClick={() => { setRole(r); navigate({ name: "home" }); }}
                  className={`px-3 py-1 rounded-full border ${role === r ? "bg-gray-900 text-white" : "bg-white"}`}>
                  {r}
                </button>
              ))}
            </div>
          </div>
        );
      }

      function SubHeader({ title, onBack }: { title: string; onBack: () => void }) {
        return (
          <div className="flex items-center gap-3 mb-4">
            <button onClick={onBack} className="px-3 py-1 rounded-xl border">← Back</button>
            <div className="text-lg font-semibold">{title}</div>
          </div>
        );
      }

      function KPI({ label, value, hint }: { label: string; value: string; hint?: string }) {
        return (
          <div className="rounded-2xl shadow p-4">
            <div className="text-gray-500 text-sm" title={hint}>{label}</div>
            <div className="text-xl font-semibold">{value}</div>
          </div>
        );
      }

      function ScoreChip({ score }: { score: number }) {
        const color = score >= 90 ? "bg-green-100 text-green-800" :
                      score >= 75 ? "bg-yellow-100 text-yellow-800" :
                                    "bg-red-100 text-red-800";
        return <span className={`px-2 py-1 rounded-full text-xs ${color}`}>{score}</span>;
      }

      /* -------------------- FPO -------------------- */
      function FPOView({ navigate }: { navigate: (r: Route) => void }) {
        const [lots, setLots] = useState<Lot[]>(seedLots);
        const [form, setForm] = useState({ crop: "", variety: "", weight: "" });
        const addLot = () => {
          if (!form.crop || !form.variety || !form.weight) return;
          const id = nextLotId(lots.length);
          const weight = parseFloat(form.weight);
          setLots([{ id, crop: form.crop, variety: form.variety, weight, score: 88, days: 7 }, ...lots]);
          setForm({ crop: "", variety: "", weight: "" });
        };
        return (
          <div className="grid gap-6">
            <div className="grid grid-cols-3 gap-4">
              <KPI label="Accepted-weight %" value="82%" hint="Accepted weight / total delivered in last 30 days" />
              <KPI label="Active lots" value={`${lots.length}`} />
              <KPI label="Next payout" value="T+2 days" />
            </div>

            <div className="rounded-2xl border p-4 grid gap-3">
              <div className="font-semibold">Create Lot</div>
              <div className="grid grid-cols-3 gap-3">
                <input className="border p-2 rounded-xl" placeholder="Crop" value={form.crop} onChange={(e)=>setForm({...form, crop:e.target.value})}/>
                <input className="border p-2 rounded-xl" placeholder="Variety" value={form.variety} onChange={(e)=>setForm({...form, variety:e.target.value})}/>
                <input className="border p-2 rounded-xl" placeholder="Est. weight (kg)" value={form.weight} onChange={(e)=>setForm({...form, weight:e.target.value})}/>
              </div>
              <div className="flex gap-3">
                <button className="px-4 py-2 rounded-xl bg-gray-900 text-white" onClick={addLot}>Save Lot</button>
                <button className="px-4 py-2 rounded-xl border" onClick={() => navigate({ name: "fpo.pre-cool" })}>Find Pre-cool Slot</button>
              </div>
            </div>

            <div className="grid gap-3">
              <div className="font-semibold">My Lots</div>
              <div className="grid md:grid-cols-3 gap-3">
                {lots.map((l) => (
                  <div key={l.id} className="rounded-2xl border p-4 grid gap-2">
                    <div className="flex justify-between items-center">
                      <div className="font-semibold">{l.id}</div>
                      <ScoreChip score={l.score} />
                    </div>
                    <div className="text-sm text-gray-600">{l.crop} • {l.variety} • {l.weight} kg</div>
                    <div className="text-xs">Shelf-life left: {l.days} days</div>
                    <div className="flex gap-2">
                      <button className="px-3 py-1 rounded-xl border" onClick={() => navigate({ name: "fpo.pre-cool", params: { lotId: l.id } })}>Book Pre-cool</button>
                      <button className="px-3 py-1 rounded-xl border" onClick={() => navigate({ name: "fpo.find-reefer", params: { lotId: l.id } })}>Find Reefer</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      function PreCoolBookingPage({ onBack, lotId }: { onBack: () => void; lotId?: string }) {
        const [store, setStore] = useState("Nashik Packhouse A");
        const [slot, setSlot] = useState("Today 6–8 PM");
        const [confirmed, setConfirmed] = useState(false);
        return (
          <div>
            <SubHeader title="Book Pre-cool" onBack={onBack} />
            <div className="grid md:grid-cols-2 gap-4">
              <div className="rounded-2xl border p-4 grid gap-3">
                <div className="text-sm text-gray-600">Lot</div>
                <input className="border p-2 rounded-xl" value={lotId || "Select from My Lots"} readOnly />
                <div className="text-sm text-gray-600">Packhouse</div>
                <select className="border p-2 rounded-xl" value={store} onChange={(e)=>setStore(e.target.value)}>
                  <option>Nashik Packhouse A</option>
                  <option>Nashik Packhouse B</option>
                  <option>Pune Packhouse North</option>
                </select>
                <div className="text-sm text-gray-600">Slot</div>
                <select className="border p-2 rounded-xl" value={slot} onChange={(e)=>setSlot(e.target.value)}>
                  <option>Today 6–8 PM</option>
                  <option>Today 8–10 PM</option>
                  <option>Tomorrow 6–8 AM</option>
                </select>
                <button className="px-4 py-2 rounded-xl bg-gray-900 text-white" onClick={()=>setConfirmed(true)}>Confirm Booking</button>
                {confirmed && <div className="text-green-700 text-sm">Booked! Gate pass & QR sent to your app.</div>}
              </div>
              <div className="rounded-2xl border p-4 text-sm">
                <div className="font-semibold mb-2">Slot Utilization</div>
                <ul className="list-disc ml-5 space-y-1">
                  <li>Pre-cool SOP: 3.2°C, 90% RH, 45 min dwell</li>
                  <li>Live queue: 2 trucks ahead at {store}</li>
                  <li>Penalty-free cancel window: 60 min before slot</li>
                </ul>
              </div>
            </div>
          </div>
        );
      }

      function FindReeferPage({ onBack, lotId }: { onBack: () => void; lotId?: string }) {
        const [origin, setOrigin] = useState("Nashik");
        const [dest, setDest] = useState("Mumbai DC");
        const [date, setDate] = useState<string>(new Date().toISOString().slice(0,10));
        const [coLoad, setCoLoad] = useState(true);
        const estimate = useMemo(() => {
          const base = 9000;
          const co = coLoad ? -1200 : 0;
          const dist = dest.includes("Pune") ? -300 : 0;
          return base + co + dist;
        }, [coLoad, dest]);
        return (
          <div>
            <SubHeader title="Find Reefer" onBack={onBack} />
            <div className="grid md:grid-cols-2 gap-4">
              <div className="rounded-2xl border p-4 grid gap-3">
                <label className="text-sm text-gray-600">Lot</label>
                <input className="border p-2 rounded-xl" value={lotId || "Select from My Lots"} readOnly />
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <div className="text-sm text-gray-600">Origin</div>
                    <input className="border p-2 rounded-xl" value={origin} onChange={(e)=>setOrigin(e.target.value)} />
                  </div>
                  <div>
                    <div className="text-sm text-gray-600">Destination</div>
                    <select className="border p-2 rounded-xl" value={dest} onChange={(e)=>setDest(e.target.value)}>
                      <option>Mumbai DC</option>
                      <option>Pune DC</option>
                      <option>Nhava Sheva (Port)</option>
                    </select>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <div className="text-sm text-gray-600">Pickup date</div>
                    <input type="date" className="border p-2 rounded-xl" value={date} onChange={(e)=>setDate(e.target.value)} />
                  </div>
                  <div className="flex items-end gap-2">
                    <input id="cl" type="checkbox" className="w-4 h-4" checked={coLoad} onChange={(e)=>setCoLoad(e.target.checked)} />
                    <label htmlFor="cl" className="text-sm">Allow co-load to reduce cost</label>
                  </div>
                </div>
                <div className="rounded-xl bg-gray-50 p-3 text-sm">
                  <div>Suggested lane: {origin} → {dest}</div>
                  <div>Est. freight: ₹{estimate.toLocaleString()}</div>
                  <div>ETA: 6h 30m • SOP: 3°C / 90% RH</div>
                </div>
                <button className="px-4 py-2 rounded-xl bg-gray-900 text-white">Book Reefer</button>
              </div>
              <div className="rounded-2xl border p-4 text-sm">
                <div className="font-semibold mb-2">Carrier Options</div>
                <ul className="space-y-2">
                  <li className="flex justify-between"><span>Vendor A • sealed doors • live telemetry</span><span>₹9,200</span></li>
                  <li className="flex justify-between"><span>Vendor B • reusable crates</span><span>₹8,800</span></li>
                  <li className="flex justify-between"><span>Vendor C • Pharma-grade reefer</span><span>₹10,400</span></li>
                </ul>
              </div>
            </div>
          </div>
        );
      }

      /* -------------------- DISTRIBUTOR -------------------- */
      function DistributorView({ navigate }: { navigate: (r: Route) => void }) {
        const lanes = [
          { name: "Nashik → Mumbai DC", km: 175, co: "High", risk: "Low" },
          { name: "Nashik → Pune DC", km: 210, co: "Med", risk: "Med" },
          { name: "Nashik → Nhava Sheva (Port)", km: 180, co: "Low", risk: "High" },
        ];
        return (
          <div className="grid gap-6">
            <div className="grid grid-cols-3 gap-4">
              <KPI label="Active trips" value="8" />
              <KPI label="On-time %" value="93%" />
              <KPI label="Dispute TAT" value="&lt; 48h" />
            </div>

            <div className="rounded-2xl border p-4 grid gap-3">
              <div className="font-semibold">Lane Planner</div>
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left border-b"><th className="py-2">Lane</th><th>km</th><th>Co-load</th><th>Risk</th><th></th></tr>
                </thead>
                <tbody>
                  {lanes.map((ln)=> (
                    <tr className="border-b" key={ln.name}>
                      <td className="py-2">{ln.name}</td>
                      <td>{ln.km}</td><td>{ln.co}</td><td>{ln.risk}</td>
                      <td><button className="px-3 py-1 rounded-xl border" onClick={()=> navigate({ name: "dist.build", params: { lane: ln.name, km: ln.km } })}>Build Load</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="rounded-2xl border p-4 grid gap-3">
              <div className="font-semibold">Trip Monitor</div>
              <div className="grid md:grid-cols-3 gap-3">
                {seedLots.map((l) => (
                  <div key={l.id} className="rounded-2xl border p-4 grid gap-2">
                    <div className="flex justify-between items-center">
                      <div className="font-semibold">{l.id}</div>
                      <ScoreChip score={l.score} />
                    </div>
                    <div className="text-sm text-gray-600">Temp: 3.1°C • Humidity: 90% • ETA: 01:12</div>
                    <div className="flex gap-2">
                      <button className="px-3 py-1 rounded-xl border" onClick={() => navigate({ name: "dist.nudge", params: { lotId: l.id } })}>Nudge SOP</button>
                      <button className="px-3 py-1 rounded-xl border" onClick={() => navigate({ name: "dist.reroute", params: { lotId: l.id } })}>Reroute</button>
                      <button className="px-3 py-1 rounded-xl border" onClick={() => navigate({ name: "dist.dispute", params: { lotId: l.id } })}>Raise Dispute</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      function BuildLoadPage({ onBack, lane, km }: { onBack: () => void; lane: string; km: number }) {
        const [vehicleCap, setVehicleCap] = useState(1200);
        const [tempSet, setTempSet] = useState(3);
        const [coLoad, setCoLoad] = useState(true);
        const [crate, setCrate] = useState("Reusable crates");
        const [insurance, setInsurance] = useState(true);
        const [selected, setSelected] = useState<{ lot: Lot; qty: number }[]>([]);
        const addLot = (lot: Lot) => {
          const idx = selected.findIndex((s)=> s.lot.id === lot.id);
          if (idx >= 0) { const c=[...selected]; c[idx].qty = Math.min(vehicleCap, c[idx].qty + 100); setSelected(c); }
          else setSelected([...selected, { lot, qty: 100 }]);
        };
        const removeLot = (i:number) => { const c=[...selected]; c.splice(i,1); setSelected(c); };
        const totalKg = selected.reduce((s,i)=> s+i.qty, 0);
        const util = Math.min(100, Math.round((totalKg/vehicleCap)*100));
        const cost = React.useMemo(()=> {
          const basePerKm = 20;
          let c = basePerKm * km;
          if (coLoad) c *= 0.9;
          if (insurance) c += 500;
          return Math.round(c);
        }, [km, coLoad, insurance]);
        const perKg = totalKg ? Math.round((cost/totalKg)*100)/100 : 0;
        const [posted, setPosted] = useState(false);

        return (
          <div>
            <SubHeader title={`Build Load – ${lane}`} onBack={onBack} />
            <div className="grid md:grid-cols-2 gap-4">
              <div className="rounded-2xl border p-4 grid gap-3">
                <div className="text-sm text-gray-600">Vehicle capacity</div>
                <input type="number" className="border p-2 rounded-xl" value={vehicleCap} onChange={(e)=>setVehicleCap(parseInt(e.target.value||"0"))} />
                <div className="text-sm text-gray-600">Temp setpoint (°C)</div>
                <input type="number" className="border p-2 rounded-xl" value={tempSet} onChange={(e)=>setTempSet(parseFloat(e.target.value||"0"))} />
                <div className="flex items-center gap-2">
                  <input id="co" type="checkbox" className="w-4 h-4" checked={coLoad} onChange={(e)=>setCoLoad(e.target.checked)} />
                  <label htmlFor="co" className="text-sm">Allow co-load</label>
                </div>
                <div className="text-sm text-gray-600">Packaging</div>
                <select className="border p-2 rounded-xl" value={crate} onChange={(e)=>setCrate(e.target.value)}>
                  <option>Reusable crates</option>
                  <option>RPC + liners</option>
                  <option>Standard cartons</option>
                </select>
                <div className="flex items-center gap-2">
                  <input id="ins" type="checkbox" className="w-4 h-4" checked={insurance} onChange={(e)=>setInsurance(e.target.checked)} />
                  <label htmlFor="ins" className="text-sm">In-transit insurance</label>
                </div>

                <div className="text-sm font-medium">Utilization</div>
                <div className="util-bar">
                  <div className="util-fill" style={{width:`${util}%`, background: util>=90 ? '#16a34a' : util>=60 ? '#f59e0b' : '#ef4444'}}></div>
                </div>
                <div className="text-xs text-gray-600">{totalKg} / {vehicleCap} kg ({util}%)</div>

                <div className="rounded-xl bg-gray-50 p-3 text-sm grid gap-1">
                  <div>Lane: {lane} • {km} km</div>
                  <div>Est. cost: ₹{cost.toLocaleString()} {totalKg?`• ~₹${perKg}/kg`:''}</div>
                  <div>Compliance: SOP {tempSet}°C / 90% RH • {crate}</div>
                </div>
              </div>

              <div className="rounded-2xl border p-4 grid gap-3">
                <div className="font-semibold">Add Lots</div>
                <div className="grid md:grid-cols-2 gap-2">
                  {seedLots.map(l => (
                    <div key={l.id} className="rounded-xl border p-3 text-sm grid gap-1">
                      <div className="flex items-center justify-between">
                        <div className="font-medium">{l.crop} • {l.variety}</div>
                        <ScoreChip score={l.score}/>
                      </div>
                      <div>{l.id} • {l.weight} kg • {l.days}d</div>
                      <button className="px-2 py-1 rounded-lg border" onClick={()=>addLot(l)}>+100 kg</button>
                    </div>
                  ))}
                </div>

                <div className="font-semibold mt-2">Current Load</div>
                {selected.length===0 ? <div className="text-sm text-gray-600">No lots added yet.</div> : (
                  <div className="grid gap-2">
                    {selected.map((s, i)=> (
                      <div key={s.lot.id} className="flex items-center justify-between text-sm">
                        <div>{s.lot.crop} • {s.lot.variety} ({s.lot.id})</div>
                        <div className="flex items-center gap-2">
                          <button className="px-2 py-1 rounded-lg border" onClick={()=>{ const c=[...selected]; c[i].qty = Math.max(0, c[i].qty - 100); setSelected(c.filter(x=>x.qty>0)); }}>-100</button>
                          <div className="w-16 text-right">{s.qty} kg</div>
                          <button className="px-2 py-1 rounded-lg border" onClick={()=>{ const c=[...selected]; c[i].qty = Math.min(vehicleCap, c[i].qty + 100); setSelected(c); }}>+100</button>
                          <button className="px-2 py-1 rounded-lg border" onClick={()=>removeLot(i)}>Remove</button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                <button className="px-4 py-2 rounded-xl bg-gray-900 text-white w-max mt-2" onClick={()=>setPosted(true)} disabled={selected.length===0}>
                  Post Load to Carriers
                </button>
                {posted && <div className="text-green-700 text-sm">Tender posted to carriers. Responses will appear under Trip Monitor.</div>}
              </div>
            </div>
          </div>
        );
      }

      function NudgeSOPPage({ onBack, lotId }: { onBack: () => void; lotId?: string }) {
        const [nudge, setNudge] = useState("Close doors / reduce openings");
        const [note, setNote] = useState("");
        const [sent, setSent] = useState(false);
        return (
          <div>
            <SubHeader title={`Nudge SOP – ${lotId || "Select lot"}`} onBack={onBack} />
            <div className="rounded-2xl border p-4 grid gap-3 max-w-2xl">
              <div className="text-sm text-gray-600">Action</div>
              <select className="border p-2 rounded-xl" value={nudge} onChange={(e)=>setNudge(e.target.value)}>
                <option>Close doors / reduce openings</option>
                <option>Increase airflow (fan speed +10%)</option>
                <option>Temp reset to 3°C</option>
                <option>Hold at nearest cold room</option>
              </select>
              <div className="text-sm text-gray-600">Optional note</div>
              <textarea className="border p-2 rounded-xl" rows={3} value={note} onChange={(e)=>setNote(e.target.value)} placeholder="Add context for the driver / hub"></textarea>
              <button className="px-4 py-2 rounded-xl bg-gray-900 text-white" onClick={() => setSent(true)}>Send Nudge</button>
              {sent && <div className="text-green-700 text-sm">Nudge sent to driver + hub. Auto-logged to shipment timeline.</div>}
            </div>
          </div>
        );
      }

      function ReroutePage({ onBack, lotId }: { onBack: () => void; lotId?: string }) {
        const [dest, setDest] = useState("Mumbai DC");
        const [reason, setReason] = useState("Avoid congestion / meet cut-off");
        const [delta] = useState<{ eta: string; cost: number }>({ eta: "+38 min", cost: 900 });
        return (
          <div>
            <SubHeader title={`Reroute – ${lotId || "Select lot"}`} onBack={onBack} />
            <div className="grid md:grid-cols-2 gap-4">
              <div className="rounded-2xl border p-4 grid gap-3">
                <div className="text-sm text-gray-600">New destination</div>
                <select className="border p-2 rounded-xl" value={dest} onChange={(e)=>setDest(e.target.value)}>
                  <option>Mumbai DC</option>
                  <option>Pune DC</option>
                  <option>Nhava Sheva (Port)</option>
                </select>
                <div className="text-sm text-gray-600">Reason</div>
                <select className="border p-2 rounded-xl" value={reason} onChange={(e)=>setReason(e.target.value)}>
                  <option>Avoid congestion / meet cut-off</option>
                  <option>Temp breach risk – need cold room</option>
                  <option>Buyer request – gate slot change</option>
                </select>
                <div className="rounded-xl bg-gray-50 p-3 text-sm">
                  <div>ETA delta: {delta.eta}</div>
                  <div>Estimated cost delta: ₹{delta.cost}</div>
                  <div>Compliance: SOP unchanged (3°C/90% RH)</div>
                </div>
                <button className="px-4 py-2 rounded-xl bg-gray-900 text-white">Confirm Reroute</button>
              </div>
              <div className="rounded-2xl border p-4 text-sm">
                <div className="font-semibold mb-2">What we consider</div>
                <ul className="list-disc ml-5 space-y-1">
                  <li>Current telematics (ΔT, door events, dwell)</li>
                  <li>Buyer gate-in windows / cut-offs</li>
                  <li>Traffic + road works + toll queues</li>
                  <li>Cost-to-serve vs. penalty risk</li>
                </ul>
              </div>
            </div>
          </div>
        );
      }

      function DisputePage({ onBack, lotId }: { onBack: () => void; lotId?: string }) {
        const [type, setType] = useState("Temp breach claim");
        const [desc, setDesc] = useState("");
        const [raised, setRaised] = useState(false);
        return (
          <div>
            <SubHeader title={`Raise Dispute – ${lotId || "Select lot"}`} onBack={onBack} />
            <div className="rounded-2xl border p-4 grid gap-3 max-w-2xl">
              <div className="grid md:grid-cols-2 gap-3">
                <div>
                  <div className="text-sm text-gray-600">Dispute type</div>
                  <select className="border p-2 rounded-xl" value={type} onChange={(e)=>setType(e.target.value)}>
                    <option>Temp breach claim</option>
                    <option>Short delivery / weight diff</option>
                    <option>Quality grade mismatch</option>
                  </select>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Attach evidence (mock)</div>
                  <input type="file" className="border p-2 rounded-xl w-full" />
                </div>
              </div>
              <div className="text-sm text-gray-600">Details</div>
              <textarea className="border p-2 rounded-xl" rows="4" value={desc} onChange={(e)=>setDesc(e.target.value)} placeholder="Describe issue, location, timestamp…"></textarea>
              <div className="rounded-xl bg-gray-50 p-3 text-sm">Auto-attach: telemetry snippet, location, Freshness Score timeline.</div>
              <button className="px-4 py-2 rounded-xl bg-gray-900 text-white" onClick={()=>setRaised(true)}>Submit Dispute</button>
              {raised && <div className="text-green-700 text-sm">Dispute submitted. SLA: &lt; 48h. Tracking ID mailed.</div>}
            </div>
          </div>
        );
      }

      /* -------------------- RETAILER -------------------- */
      function RetailerView({ onBuy, cart, setCart, navigate }:
        { onBuy: (lot: Lot) => void; cart: { lot: Lot; qty: number }[]; setCart: (v: { lot: Lot; qty: number }[]) => void; navigate: (r: Route)=>void }) {
        const [sortKey, setSortKey] = useState<"score" | "days" | "weight">("score");
        const sorted = useMemo(() => {
          const arr = [...seedLots];
          arr.sort((a,b)=> sortKey === "score" ? b.score - a.score : sortKey === "days" ? b.days - a.days : b.weight - a.weight);
          return arr;
        }, [sortKey]);

        return (
          <div className="grid gap-6">
            <div className="grid grid-cols-3 gap-4">
              <KPI label="Shrink (pilot SKUs)" value="-32%" />
              <KPI label="On-shelf avail." value="+2.8 pp" />
              <KPI label="Dispute TAT" value="&lt; 48h" />
            </div>

            <div className="rounded-2xl border p-4 grid gap-3">
              <div className="font-semibold">Inbound Queue</div>
              <div className="grid md:grid-cols-3 gap-3">
                {seedLots.map((l) => (
                  <div key={l.id} className="rounded-2xl border p-4 grid gap-2">
                    <div className="flex justify-between items-center">
                      <div className="font-semibold">{l.crop} • {l.variety}</div>
                      <ScoreChip score={l.score} />
                    </div>
                    <div className="text-sm text-gray-600">{l.id} • {l.weight} kg • {l.days} days left</div>
                    <div className="flex gap-2">
                      <button className="px-3 py-1 rounded-xl border" onClick={()=>navigate({ name:"retailer.qc", params:{ lotId:l.id }})}>Gate-in QC</button>
                      <button className="px-3 py-1 rounded-xl border" onClick={()=>navigate({ name:"retailer.fast", params:{ lotId:l.id }})}>Fast-track</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="rounded-2xl border p-4 grid gap-3">
              <div className="flex items-center justify-between">
                <div className="font-semibold">Marketplace (Verified Lots)</div>
                <div className="text-sm flex items-center gap-2">
                  <span>Sort by</span>
                  <select className="border p-1 rounded-lg" value={sortKey} onChange={(e)=>setSortKey(e.target.value)}>
                    <option value="score">Freshness Score</option>
                    <option value="days">Shelf-life left</option>
                    <option value="weight">Weight</option>
                  </select>
                </div>
              </div>
              <div className="grid md:grid-cols-3 gap-3">
                {sorted.map((l) => (
                  <div key={l.id} className="rounded-2xl border p-4 grid gap-2">
                    <div className="flex justify-between items-center">
                      <div className="font-semibold">{l.crop} • {l.variety}</div>
                      <ScoreChip score={l.score} />
                    </div>
                    <div className="text-sm text-gray-600">{l.weight} kg • {l.days} days left</div>
                    <button className="px-3 py-1 rounded-xl bg-gray-900 text-white" onClick={() => onBuy(l)}>Buy</button>
                  </div>
                ))}
              </div>
            </div>

            <!-- Inline cart -->
            <div className="rounded-2xl border p-4 grid gap-3">
              <div className="flex items-center justify-between">
                <div className="font-semibold">Cart</div>
                <div className="text-xs text-gray-500">Click Buy to add 100kg per click</div>
              </div>
              {cart.length === 0 ? (
                <div className="text-sm text-gray-600">Your cart is empty.</div>
              ) : (
                <div className="grid gap-3">
                  {cart.map((it, idx) => (
                    <div key={idx} className="flex items-center justify-between gap-2">
                      <div className="text-sm">{it.lot.crop} • {it.lot.variety} ({it.lot.id})</div>
                      <div className="flex items-center gap-2">
                        <button className="px-2 py-1 rounded-lg border" onClick={()=>{
                          const copy = [...cart]; copy[idx].qty = Math.max(0, copy[idx].qty - 100); setCart(copy.filter(x=>x.qty>0));
                        }}>-100kg</button>
                        <div className="w-24 text-right">{it.qty} kg</div>
                        <button className="px-2 py-1 rounded-lg border" onClick={()=>{
                          const copy = [...cart]; copy[idx].qty = copy[idx].qty + 100; setCart(copy);
                        }}>+100kg</button>
                      </div>
                    </div>
                  ))}
                  <div className="flex justify-between pt-2 border-t mt-2 text-sm">
                    <div>Total</div>
                    <div>{cart.reduce((s,i)=> s + i.qty, 0)} kg</div>
                  </div>
                  <button className="px-4 py-2 rounded-xl bg-gray-900 text-white w-max">Checkout (mock)</button>
                </div>
              )}
            </div>
          </div>
        );
      }

      function RetailerQCPage({ onBack, lotId }: { onBack: () => void; lotId?: string }) {
        const lot = seedLots.find(l=> l.id===lotId);
        const [tempOK, setTempOK] = useState(true);
        const [appearanceOK, setAppearanceOK] = useState(true);
        const [weightDiff, setWeightDiff] = useState(0);
        const [grade, setGrade] = useState("A");
        const [acceptKg, setAcceptKg] = useState(lot? Math.min(lot.weight, 500): 500);
        const [done, setDone] = useState(false);
        return (
          <div>
            <SubHeader title={`Gate-in QC – ${lotId || "Select lot"}`} onBack={onBack} />
            <div className="grid md:grid-cols-2 gap-4">
              <div className="rounded-2xl border p-4 grid gap-3">
                <div className="text-sm text-gray-600">Temperature on arrival within range (≤4°C)?</div>
                <input type="checkbox" className="w-4 h-4" checked={tempOK} onChange={(e)=>setTempOK(e.target.checked)} />
                <div className="text-sm text-gray-600">Appearance / bruising acceptable?</div>
                <input type="checkbox" className="w-4 h-4" checked={appearanceOK} onChange={(e)=>setAppearanceOK(e.target.checked)} />
                <div className="text-sm text-gray-600">Weighbridge diff (kg)</div>
                <input type="number" className="border p-2 rounded-xl" value={weightDiff} onChange={(e)=>setWeightDiff(parseInt(e.target.value||"0"))} />
                <div className="text-sm text-gray-600">Grade</div>
                <select className="border p-2 rounded-xl" value={grade} onChange={(e)=>setGrade(e.target.value)}>
                  <option>A</option><option>B</option><option>C</option>
                </select>
                <div className="text-sm text-gray-600">Accept quantity (kg)</div>
                <input type="number" className="border p-2 rounded-xl" value={acceptKg} onChange={(e)=>setAcceptKg(parseInt(e.target.value||"0"))} />
                <button className="px-4 py-2 rounded-xl bg-gray-900 text-white" onClick={()=>setDone(true)}>Complete QC</button>
              </div>
              <div className="rounded-2xl border p-4 text-sm">
                <div className="font-semibold mb-2">Decision Preview</div>
                <ul className="list-disc ml-5 space-y-1">
                  <li>QC status: {(tempOK && appearanceOK) ? "Pass" : "Conditional pass"}</li>
                  <li>Grade: {grade}</li>
                  <li>Accepted: {acceptKg} kg {weightDiff?`(Δ weighbridge: ${weightDiff} kg)`:''}</li>
                  <li>Actions: put-away to {grade} rack • auto-generate GRN</li>
                </ul>
                {done && <div className="text-green-700 mt-2">QC completed. GRN created and inventory updated.</div>}
              </div>
            </div>
          </div>
        );
      }

      function RetailerFastTrackPage({ onBack, lotId }: { onBack: () => void; lotId?: string }) {
        const [dock, setDock] = useState("Dock 2");
        const [priority, setPriority] = useState("High");
        const [notify, setNotify] = useState({ catMgr: true, storeOps: true });
        const [confirmed, setConfirmed] = useState(false);
        return (
          <div>
            <SubHeader title={`Fast-track – ${lotId || "Select lot"}`} onBack={onBack} />
            <div className="grid md:grid-cols-2 gap-4">
              <div className="rounded-2xl border p-4 grid gap-3">
                <div className="text-sm text-gray-600">Assign dock</div>
                <select className="border p-2 rounded-xl" value={dock} onChange={(e)=>setDock(e.target.value)}>
                  <option>Dock 1</option><option>Dock 2</option><option>Dock 3</option>
                </select>
                <div className="text-sm text-gray-600">Priority</div>
                <select className="border p-2 rounded-xl" value={priority} onChange={(e)=>setPriority(e.target.value)}>
                  <option>High</option><option>Medium</option><option>Low</option>
                </select>
                <div className="flex items-center gap-2">
                  <input id="n1" type="checkbox" className="w-4 h-4" checked={notify.catMgr} onChange={(e)=>setNotify({...notify, catMgr:e.target.checked})} />
                  <label htmlFor="n1" className="text-sm">Notify Category Manager</label>
                </div>
                <div className="flex items-center gap-2">
                  <input id="n2" type="checkbox" className="w-4 h-4" checked={notify.storeOps} onChange={(e)=>setNotify({...notify, storeOps:e.target.checked})} />
                  <label htmlFor="n2" className="text-sm">Notify Store Ops</label>
                </div>
                <button className="px-4 py-2 rounded-xl bg-gray-900 text-white" onClick={()=>setConfirmed(true)}>Confirm Fast-track</button>
              </div>
              <div className="rounded-2xl border p-4 text-sm">
                <div className="font-semibold mb-2">Impact</div>
                <ul className="list-disc ml-5 space-y-1">
                  <li>Queue position bumped to front</li>
                  <li>Expected gate-out: +15 min from now</li>
                  <li>Shelf availability boost projected +0.7 pp</li>
                  <li>Auto-create task: put-away within 30 min</li>
                </ul>
                {confirmed && <div className="text-green-700 mt-2">Fast-track scheduled at {dock}. Notifications sent.</div>}
              </div>
            </div>
          </div>
        );
      }

      /* -------------------- APP -------------------- */
      function CartPage({ onBack, items, setItems }: { onBack: () => void; items: { lot: Lot; qty: number }[]; setItems: (v: { lot: Lot; qty: number }[]) => void }) {
        const totalKg = items.reduce((s,i)=> s + i.qty, 0);
        return (
          <div>
            <SubHeader title="Cart" onBack={onBack} />
            {items.length === 0 ? (
              <div className="text-sm text-gray-600">Your cart is empty.</div>
            ) : (
              <div className="rounded-2xl border p-4 grid gap-3">
                {items.map((it, idx) => (
                  <div key={idx} className="flex items-center justify-between gap-2">
                    <div className="text-sm">{it.lot.crop} • {it.lot.variety} ({it.lot.id})</div>
                    <div className="flex items-center gap-2">
                      <button className="px-2 py-1 rounded-lg border" onClick={()=>{ const copy = [...items]; copy[idx].qty = Math.max(0, copy[idx].qty - 100); setItems(copy.filter(x=>x.qty>0)); }}>-100kg</button>
                      <div className="w-24 text-right">{it.qty} kg</div>
                      <button className="px-2 py-1 rounded-lg border" onClick={()=>{ const copy = [...items]; copy[idx].qty = copy[idx].qty + 100; setItems(copy); }}>+100kg</button>
                    </div>
                  </div>
                ))}
                <div className="flex justify-between pt-2 border-t mt-2 text-sm">
                  <div>Total</div>
                  <div>{totalKg} kg</div>
                </div>
                <button className="px-4 py-2 rounded-xl bg-gray-900 text-white w-max">Checkout (mock)</button>
              </div>
            )}
          </div>
        );
      }

      function App() {
        const [role, setRole] = useState<Role>("FPO");
        const [route, setRoute] = useState<Route>({ name: "home" });
        const [cart, setCart] = useState<{ lot: Lot; qty: number }[]>([]);

        const navigate = (r: Route) => setRoute(r);
        const onBuy = (lot: Lot) => {
          setCart((prev) => {
            const idx = prev.findIndex((p) => p.lot.id === lot.id);
            if (idx >= 0) { const copy = [...prev]; copy[idx].qty += 100; return copy; }
            return [...prev, { lot, qty: 100 }];
          });
        };

        return (
          <div className="max-w-6xl mx-auto p-6">
            <Header role={role} setRole={setRole} navigate={navigate} />
            {motion ? (
              <motion.div key={`${role}-${route.name}`} initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }} className="mt-4">
                {route.name === "home" && role === "FPO" && <FPOView navigate={navigate} />}
                {route.name === "home" && role === "Distributor" && <DistributorView navigate={navigate} />}
                {route.name === "home" && role === "Retailer" && <RetailerView onBuy={onBuy} cart={cart} setCart={setCart} navigate={navigate} />}

                {route.name === "fpo.pre-cool" && <PreCoolBookingPage onBack={() => navigate({ name: "home" })} lotId={route.params?.lotId} />}
                {route.name === "fpo.find-reefer" && <FindReeferPage onBack={() => navigate({ name: "home" })} lotId={route.params?.lotId} />}

                {route.name === "dist.build" && <BuildLoadPage onBack={() => navigate({ name: "home" })} lane={route.params?.lane} km={route.params?.km || 0} />}
                {route.name === "dist.nudge" && <NudgeSOPPage onBack={() => navigate({ name: "home" })} lotId={route.params?.lotId} />}
                {route.name === "dist.reroute" && <ReroutePage onBack={() => navigate({ name: "home" })} lotId={route.params?.lotId} />}
                {route.name === "dist.dispute" && <DisputePage onBack={() => navigate({ name: "home" })} lotId={route.params?.lotId} />}

                {route.name === "retailer.qc" && <RetailerQCPage onBack={() => navigate({ name: "home" })} lotId={route.params?.lotId} />}
                {route.name === "retailer.fast" && <RetailerFastTrackPage onBack={() => navigate({ name: "home" })} lotId={route.params?.lotId} />}
                {route.name === "retailer.cart" && <CartPage onBack={() => navigate({ name: "home" })} items={cart} setItems={setCart} />}
              </motion.div>
            ) : (
              <div className="mt-4 text-sm text-red-600">Framer Motion failed to load from CDN.</div>
            )}

            <div className="mt-10 text-xs text-gray-500">
              <div className="font-semibold mb-1">Extra interactive touches</div>
              <ul className="list-disc ml-5 space-y-1">
                <li>Retailer: Gate-in QC & Fast-track workflows.</li>
                <li>Distributor: Build Load util & cost + tender.</li>
                <li>Retailer inline cart; 100kg step.</li>
                <li>Pre-cool booking & Reefer cost estimator.</li>
              </ul>
            </div>
          </div>
        );
      }

      const root = createRoot(document.getElementById("root"));
      root.render(<App />);

      // tiny smoke tests (console)
      (() => { try {
        console.assert(nextLotId(0) === "LOT-NSK-001");
        console.assert(nextLotId(9) === "LOT-NSK-010");
        console.assert(nextLotId(99) === "LOT-NSK-100");
      } catch(e) { console.error("Smoke tests failed", e); } })();
    </script>
  </body>
</html>
